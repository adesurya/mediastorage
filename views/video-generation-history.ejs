<!-- views/video-generation-history.ejs -->
<%- include('partials/sidebar', { currentPage: 'video-generation' }) %>

<style>
  .history-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .page-title {
    font-size: 2rem;
    font-weight: 800;
    background: linear-gradient(135deg, #D4AF37 0%, #B8860B 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .btn-new {
    background: linear-gradient(135deg, #D4AF37 0%, #B8860B 100%);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
  }

  .btn-new:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(212, 175, 55, 0.3);
  }

  .history-grid {
    display: grid;
    gap: 1.5rem;
  }

  .history-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    border: 2px solid #f3f4f6;
    transition: all 0.3s;
  }

  .history-card:hover {
    box-shadow: 0 8px 16px rgba(212, 175, 55, 0.15);
    border-color: #D4AF37;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
  }

  .card-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }

  .card-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: #6b7280;
  }

  .status-badge {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .status-processing {
    background: #fef3c7;
    color: #92400e;
  }

  .status-completed {
    background: #d1fae5;
    color: #065f46;
  }

  .status-partial {
    background: #dbeafe;
    color: #1e40af;
  }

  .status-failed {
    background: #fee2e2;
    color: #991b1b;
  }

  .scenes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .scene-item {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s;
  }

  .scene-item:hover {
    border-color: #D4AF37;
  }

  .scene-number {
    font-weight: 600;
    color: #D4AF37;
    margin-bottom: 0.5rem;
  }

  .scene-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .scene-pending {
    background: #f3f4f6;
    color: #4b5563;
  }

  .scene-processing {
    background: #fef3c7;
    color: #92400e;
  }

  .scene-completed {
    background: #d1fae5;
    color: #065f46;
  }

  .scene-failed {
    background: #fee2e2;
    color: #991b1b;
  }

  .video-preview {
    width: 100%;
    border-radius: 8px;
    margin-top: 0.5rem;
  }

  .download-btn {
    background: #10b981;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.875rem;
    display: inline-block;
    margin-top: 0.5rem;
    transition: all 0.3s;
  }

  .download-btn:hover {
    background: #059669;
    transform: scale(1.05);
  }

  .delete-btn {
    background: #ef4444;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s;
  }

  .delete-btn:hover {
    background: #dc2626;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #6b7280;
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .loading-spinner {
    text-align: center;
    padding: 3rem;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f4f6;
    border-top: 4px solid #D4AF37;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .progress-info {
    margin-top: 1rem;
    padding: 1rem;
    background: #FFF9E6;
    border-radius: 8px;
    font-size: 0.875rem;
  }

  .expires-warning {
    color: #dc2626;
    font-size: 0.875rem;
    margin-top: 0.5rem;
  }
</style>

<div class="history-container">
  <div class="page-header">
    <h1 class="page-title">üìã Video Generation History</h1>
    <a href="/video-generation" class="btn-new">
      ‚ûï Buat Video Baru
    </a>
  </div>

  <div id="historyContent">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading history...</p>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  let refreshInterval;

  async function loadHistory() {
    try {
      const response = await fetch('/api/video-generation/history');
      const result = await response.json();

      if (result.success) {
        renderHistory(result.data);
      } else {
        showError('Failed to load history');
      }
    } catch (error) {
      showError(error.message);
    }
  }

  function renderHistory(generations) {
    const container = document.getElementById('historyContent');

    if (generations.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üé¨</div>
          <h3>Belum ada video generation</h3>
          <p>Mulai buat video pertama Anda!</p>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div class="history-grid">
        ${generations.map(gen => renderGenerationCard(gen)).join('')}
      </div>
    `;
  }

  function renderGenerationCard(gen) {
    const statusClass = `status-${gen.status}`;
    const statusText = {
      'processing': '‚è≥ Processing',
      'completed': '‚úÖ Completed',
      'partial': '‚ö†Ô∏è Partial',
      'failed': '‚ùå Failed'
    }[gen.status];

    const expiresAt = new Date(gen.expires_at);
    const now = new Date();
    const hoursLeft = Math.floor((expiresAt - now) / (1000 * 60 * 60));

    return `
      <div class="history-card" data-id="${gen.id}">
        <div class="card-header">
          <div>
            <h3 class="card-title">${gen.title}</h3>
            <div class="card-meta">
              <span>üìÖ ${new Date(gen.created_at).toLocaleString('id-ID')}</span>
              <span>üé¨ ${gen.total_scenes} scenes</span>
              <span>‚úÖ ${gen.completed_count || 0} completed</span>
              ${gen.failed_count > 0 ? `<span>‚ùå ${gen.failed_count} failed</span>` : ''}
            </div>
            ${hoursLeft > 0 ? `
              <div class="expires-warning">
                ‚è∞ Akan dihapus otomatis dalam ${hoursLeft} jam
              </div>
            ` : ''}
          </div>
          <div>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
        </div>

        ${gen.status === 'processing' ? `
          <div class="progress-info">
            ‚è≥ Estimasi selesai: 2-3 menit. Auto-refresh setiap 10 detik.
          </div>
        ` : ''}

        <div id="scenes-${gen.id}" class="scenes-grid">
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p style="font-size: 0.875rem;">Loading scenes...</p>
          </div>
        </div>

        <div style="text-align: right; margin-top: 1rem;">
          <button class="delete-btn" onclick="deleteGeneration(${gen.id})">
            üóëÔ∏è Hapus
          </button>
        </div>
      </div>
    `;
  }

  async function loadScenes(generationId) {
    try {
      const response = await fetch(`/api/video-generation/generation/${generationId}`);
      const result = await response.json();

      if (result.success) {
        renderScenes(generationId, result.data.scenes);
      }
    } catch (error) {
      console.error('Failed to load scenes:', error);
    }
  }

  function renderScenes(generationId, scenes) {
    const container = document.getElementById(`scenes-${generationId}`);

    container.innerHTML = scenes.map(scene => {
      const statusClass = `scene-${scene.status}`;
      const statusText = {
        'pending': 'Pending',
        'processing': 'Processing',
        'completed': 'Completed',
        'failed': 'Failed'
      }[scene.status];

      return `
        <div class="scene-item">
          <div class="scene-number">Scene ${scene.scene_number}</div>
          <span class="scene-status ${statusClass}">${statusText}</span>

          ${scene.status === 'completed' && scene.video_url ? `
            <video class="video-preview" controls>
              <source src="${scene.video_url}" type="video/mp4">
            </video>
            <a href="${scene.video_url}" download="sijagoai_${generationId}_scene${scene.scene_number}.mp4" class="download-btn">
              ‚¨áÔ∏è Download
            </a>
          ` : ''}

          ${scene.status === 'processing' ? `
            <p style="font-size: 0.75rem; margin-top: 0.5rem; color: #6b7280;">
              ‚è≥ Processing...
            </p>
          ` : ''}

          ${scene.status === 'failed' ? `
            <p style="font-size: 0.75rem; margin-top: 0.5rem; color: #ef4444;">
              ${scene.error_message || 'Generation failed'}
            </p>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  async function deleteGeneration(id) {
    if (!confirm('Yakin ingin menghapus generation ini?')) return;

    try {
      const response = await fetch(`/api/video-generation/generation/${id}`, {
        method: 'DELETE'
      });

      const result = await response.json();

      if (result.success) {
        alert('‚úÖ Generation berhasil dihapus');
        loadHistory();
      } else {
        alert('‚ùå ' + result.message);
      }
    } catch (error) {
      alert('‚ùå Error: ' + error.message);
    }
  }

  function showError(message) {
    document.getElementById('historyContent').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚ùå</div>
        <h3>Error</h3>
        <p>${message}</p>
      </div>
    `;
  }

  // Initial load
  loadHistory();

  // Load scenes for each generation after initial render
  setTimeout(() => {
    const cards = document.querySelectorAll('.history-card');
    cards.forEach(card => {
      const id = card.dataset.id;
      loadScenes(id);
    });
  }, 500);

  // Auto-refresh every 10 seconds if there are processing items
  refreshInterval = setInterval(() => {
    const processingCards = document.querySelectorAll('.status-processing');
    if (processingCards.length > 0) {
      loadHistory();
      setTimeout(() => {
        const cards = document.querySelectorAll('.history-card');
        cards.forEach(card => {
          const id = card.dataset.id;
          loadScenes(id);
        });
      }, 500);
    }
  }, 10000);

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    clearInterval(refreshInterval);
  });
</script>
